name: Build Android APK
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Direct Installation Strategy
        run: |
          # البحث عن package.json في أي مستوى وتحميل التبعيات فيه
          PACKAGE_JSON=$(find . -name "package.json" | head -n 1)
          PROJECT_DIR=$(dirname "$PACKAGE_JSON")
          echo "Target Directory identified as: $PROJECT_DIR"
          cd "$PROJECT_DIR"
          npm install --force
          npm install @capacitor/core @capacitor/android @capacitor/cli
          npm run build --if-present

      - name: Capacitor Sync
        run: |
          PACKAGE_JSON=$(find . -name "package.json" | head -n 1)
          PROJECT_DIR=$(dirname "$PACKAGE_JSON")
          cd "$PROJECT_DIR"
          npx cap sync || echo "Capacitor not initialized yet"

      - name: Final Android Build
        run: |
          # البحث عن ملف gradlew وتشغيله أينما كان
          GRADLEW_FILE=$(find . -name "gradlew" | head -n 1)
          GRADLE_DIR=$(dirname "$GRADLEW_FILE")
          echo "Gradle directory found at: $GRADLE_DIR"
          cd "$GRADLE_DIR"
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Export APK
        uses: actions/upload-artifact@v4
        with:
          name: Novexa-Final-App
          path: "**/app-debug.apk"
